# Demo Storybook with modern CSS/JS bundled for legacy browsers

This repo uses:
- Modern tooling (Parcel) to bundle SCSS & ES6+ for both modern & legacy browsers.
- Storybook/HTML to author UI components, leveraging the `autodocs` feature to auto-generate documentation.
- Custom Node scripts to (1) update UI theme, and (2) rename/move the hashed CSS/JS generated by build scripts into the appropriate production folder (`build/ui/[theme-name]/`).

> - NOTE: Storybook won't run in IE, but you can see the transpiled CSS/JS in the `public` folder (including `postcss` fixes and JS polyfills).

## Compile CSS/JS and watch for UI changes
> - NOTE: Use the correct Node version as listed in `.nvmrc`. If necessary, install Node Version Manager (NVM).

Run both the following commands in **separate terminal instances** in order to be able to compile CSS/JS and test the UI in Storybook.

- `npm run start:theme --theme=[theme-name]` - Installs Node modules (if not already installed) and launches Parcel bundler with correct UI theme (e.g. `default`).
- `npm run storybook` - Launches Storybook/HTML component library.

### UI themes
- Theme-specific CSS is located in `src/css/_THEMES` folder.
- Valid UI theme names are located in `scripts/theme-config.js`.
- To change the theme in `DEV MODE`, stop the Parcel Node process with `CTRL+C`, and `npm run start:theme --theme=[theme-name]`. The new theme will work in Storybook.

> - NOTE: There is currently no way to change themes within the Storybook interface itself (i.e. in `PROD MODE`).
> - After trying many addons, this one looks to be the best fit, but is currently [out of date with latest Storybook version](https://github.com/krzysztof01-sz/storybook-theme-switch-addon/pull/1#issuecomment-2222568910).

## Bundle CSS/JS for production without watch
- `npm run build:theme --theme=[theme-name]` - See the section further down for details of Parcel's differential bundling.

### Linking to compiled CSS/JS
- There is a difference between `development` and `production` environments in terms of the locations of the compiled CSS/JS.```
- The `<link>` and `<script>` tags in `.storybook/preview-head.html` use placeholders, which reference **environment variables** defined in `.env` files:
```
<link href="%STORYBOOK_CSS_PATH%" rel="stylesheet" />
<script defer src="%STORYBOOK_JS_PATH%"></script>
```

#### DEVELOPMENT
- Uses the Storybook dev server, with paths defined in `.env.development`:
```
STORYBOOK_CSS_PATH=index.css
STORYBOOK_JS_PATH=index.js
```

#### PRODUCTION
- Uses whatever build folder has been defined for the website / web application in `.env.production`:

```
STORYBOOK_CSS_PATH=build/ui/default/css/index.css
STORYBOOK_JS_PATH=build/ui/default/javascript/index.js
```

## Supported browsers
- The [default browserslist configuration](https://github.com/browserslist/browserslist#best-practices) has been extended in `package.json` to support IE11.
- Run `npx browserslist` to see a list of supported browsers.

## Parcel bundler
```
"start:parcel": "parcel watch src/javascript/index.js --hmr-port 1234 --target app"
```
- This command does not need to be explicitly run as `npm run start:theme --theme=[theme-name]` does it for you.
- See the `HMR` section further down for an explanation of the `--hmr-port 1234` argument.
- The `--target app` argument enables transpilation of both CSS and JS in **local DEV mode**. By default, Parcel only does this for production builds.

### JS transpilation and differential bundling
- There's no need for a `.babelrc` config. See [Parcel default Babel presets](https://parceljs.org/languages/javascript/#default-presets).
- The JS bundles contain non-transpiled `ES6+` code for modern browsers, and transpiled `ES5` code for legacy browsers. See [Parcel differential bundling](https://parceljs.org/features/targets/#differential-bundling).

### Polyfills
- A separate `polyfills` bundle is created for browsers that don't support the required features in `src/javascript/config/browser-supports-features.js`.
- For demo purposes, `dialog-polyfill` has been added.

### Sass
- Sass compilation is done automatically.
    - If Parcel sees Sass files in the project, it automatically installs `@parcel/transformer-sass`.

### Dev dependencies
- There is no need for a `.babelrc` file with additional presets (e.g. `@babel/preset-env`) and plugins.

## Storybook/HTML component library

### Hot module reloading (HMR)
- The `start:parcel` NPM script mentioned earlier doesn't actually start the default Parcel server.
- Instead, it simply [watches files and defines a port for the HMR server](https://parceljs.org/features/cli/#parcel-watch-%3Centries%3E).
- This means that Storybook updates automatically with any CSS/JS changes.

### Re-ordering stories in sidebar navigation
- All stories and docs are ordered according to the `storySort` configuration in `ui/.storybook/preview.js`.

## Trouble-shooting bundling and build issues
- If bundling breaks, or UI is not updated (in DEV mode) to reflect latest CSS/JS changes:
    - Stop the Parcel Node process with `CTRL+C`.
    - `npm run start:theme --theme=[theme-name]`.


## Build and publish Storybook
- `npm run publish-storybook` - Runs Parcel build (using the `default` theme) to bundle CSS/JS in the `public` folder, which then gets copied to `storybook-static` folder.
- This script also gets run in the Github pages workflow (`.github/static.yml`) to publish Storybook online.
- `npx http-server ./storybook-static` - Test Storybook production build on local server.

## Additional required files in project root directory
- `.editorconfig` ensures all code uses the same indentation.

## Out of scope
- No TypeScript.
- No Stylelint, Eslint, Prettier.
- No Git commit hooks (Husky).
